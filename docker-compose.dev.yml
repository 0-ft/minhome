services:
  # Override server: mount source for hot-reload instead of building an image
  server:
    image: node:22-slim
    build: !reset null
    command: sh -c "apt-get update && apt-get install -y --no-install-recommends fontconfig fonts-dejavu-core && rm -rf /var/lib/apt/lists/* && corepack enable && pnpm install && pnpm --filter @minhome/server dev"
    working_dir: /app
    volumes:
      - .:/app
      - ./data/server:/data
    environment:
      - NODE_OPTIONS=--max-old-space-size=256
      - DATA_DIR=/data
      - VITE_DEV_URL=http://frontend:5173
      - FONTCONFIG_PATH=/etc/fonts

  # Add frontend dev server (not in production compose)
  frontend:
    container_name: minhome-frontend
    image: node:22-slim
    working_dir: /app
    command: sh -c "corepack enable && pnpm install && pnpm --filter @minhome/frontend dev --host"
    volumes:
      - .:/app
    ports:
      - 5173:5173
    environment:
      - VITE_API_TARGET=http://server:3111
    depends_on:
      - server

  # Override voice-bridge: mount source for hot-reload instead of building an image
  voice-bridge:
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    build: !reset null
    command: sh -c "uv sync && uv run watchfiles 'python -u bridge.py' ."
    working_dir: /app
    volumes:
      - ./voice-bridge:/app
    network_mode: host